<!DOCTYPE html>
<html lang="en">
<head th:include="navbar.html :: head">
    <title id="title">Add product</title>
</head>
<body th:include="navbar.html :: body">
<div id="body">

    <!--/*@thymesVar id="product" type="com.struninproject.onlinestore.model.Product"*/-->
    <form action="#" th:action="@{/product/new}" th:object="${product}"
          method="POST">
        <div class="form-group">
            <label for="name">Name</label>
            <input class="form-control" type="text" th:field="*{name}" id="name"
                   placeholder="name">
            <!--    <span th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></span>-->
        </div>
        <div class="form-group">
            <!--/*@thymesVar id="price" type="java.math.BigDecimal"*/-->
            <label for="price">Price</label>
            <input class="form-control" type="text" th:field="*{price}"
                   id="price"
                   placeholder="price">
            <!--    <span th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></span>-->
        </div>
        <div class="text-right">
            <input class="btn btn-primary" type="submit"
                   value="Add manufacturer">
        </div>
        <div class="form-group">
            <!--/*@thymesVar id="description" type="java.lang.String"*/-->
            <label for="description">Description</label>
            <input class="form-control" type="text" th:field="*{description}"
                   id="description"
                   placeholder="description">
            <!--    <span th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></span>-->
        </div>
        <div class="form-group">
            <!--/*@thymesVar id="manufacturers" type="java.lang.Iterable"*/-->
            <!--/*@thymesVar id="manufacturer" type="com.struninproject.onlinestore.model.Manufacturer"*/-->
            <label for="manufacturer">Manufacturer</label>
            <select class="form-control" th:field="*{manufacturer}"
                    id="manufacturer">
                <option th:each="manufacturer : ${manufacturers}"
                        th:value="${manufacturer.getId()}"
                        th:text="${manufacturer.getName()}"></option>
            </select>
            <!--    <span th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></span>-->
        </div>
        <div id="out" class="form-group">
            <!--/*@thymesVar id="categories" type="java.lang.Iterable"*/-->
            <!--/*@thymesVar id="category" type="com.struninproject.onlinestore.model.Category"*/-->
            <label for="category">Category</label>
            <select onchange="myChangeFunction(this.value)" class="form-control"
                    th:field="*{category}" id="category">
                <option th:each="category : ${categories}"
                        th:value="${category.getId()}"
                        th:text="${category.getName()}"></option>
            </select>
            <br>
            <!--    <span th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></span>-->
        </div>
        <div class="form-group">
            <label for="input_img">Image</label>
            <div>
                <img th:src="${product.getImage()}" height="100"
                     width="auto" id="output"/>
            </div>
            <input type="file" id="input_img"
                   onchange="fileChange()" accept="image/*">
            <input type="hidden" id="image" th:field="*{image}">
            <!--        <span th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></span>-->
        </div>
        <input class="btn btn-primary" type="submit" value="Add product">
    </form>

    <script th:inline="javascript">
        function myChangeFunction(value) {
            const categories = /*[[${categories}]]*/ {};
            const elementById = document.getElementById('in');
            if (elementById) {
                elementById.remove();
            }
            const form = document.getElementById("out");
            const divIN = document.createElement('div');
            let elInput;
            let elLabel;
            divIN.setAttribute('id', 'in');
            for (let index in categories) {
                const category = categories[index];
                if (category.id === value) {
                    for (let i in category.features) {
                        elLabel = document.createElement('label');
                        elLabel.setAttribute('for', category.features[i])
                        elLabel.innerText = category.features[i];
                        elInput = document.createElement('input');
                        elInput.setAttribute('name', 'value')
                        elInput.setAttribute('value', category.features[i]);
                        elInput.setAttribute('type', 'hidden')
                        divIN.appendChild(elInput);
                        elInput = document.createElement('input');
                        elInput.setAttribute('class', 'form-control');
                        elInput.setAttribute('id', category.features[i]);
                        elInput.setAttribute('name', 'specifications' + '[' + category.features[i] + ']');
                        divIN.appendChild(elLabel);
                        divIN.appendChild(elInput);
                    }
                    form.appendChild(divIN);
                }
            }
        }
    </script>

    <script>
        function fileChange() {
            const file = document.getElementById('input_img');
            const form = new FormData();
            form.append("image", file.files[0])

            const settings = {
                "url": "https://api.imgbb.com/1/upload?key=cbe21926adeaa051d2d2546b5ed23225",
                "method": "POST",
                "timeout": 0,
                "processData": false,
                "mimeType": "multipart/form-data",
                "contentType": false,
                "data": form
            };

            $.ajax(settings).done(function (response) {
                const jx = JSON.parse(response);
                const image = document.getElementById('image');
                image.setAttribute('value', jx.data.url)
                const output = document.getElementById('output');
                output.setAttribute('height', '100');
                output.setAttribute('width', 'auto');
                output.src = jx.data.url;
            });
        };
    </script>

</div>
</body>
</html>